<html>
<head>
    <link rel="stylesheet" href="https://p.trellocdn.com/power-up.min.css">
    <script src="https://p.trellocdn.com/power-up.min.js"></script>
</head>
<body>
<form id="w2p">

    <fieldset id="link">
        <label for="w2plink">W2P Link:</label>
        <input type="url" name="w2plink" id="w2plink" />
    </fieldset>

    <fieldset id="new" style="display: none;">
        <label for="projects">Project:</label>
        <input type="text" list="projects_list" name="projects" id="projects"/>
        <datalist id="projects_list">

        </datalist>

        <label for="users">Owner:</label>
        <input type="text" list="users_list" name="users" id="users"/>
        <datalist id="users_list">

        </datalist>

        <input type="hidden" id="cardname" />

        <button id="addnew">Create new</button>
    </fieldset>

    <button id="save" type="submit" class="mod-primary">Save</button>

</form>
<script type="text/javascript">
    var t = TrelloPowerUp.iframe();

    document.getElementById("w2p").addEventListener('submit', function(event){
      // Stop the browser trying to submit the form itself.
      event.preventDefault();
      return t.set('card', 'shared', 'w2plink',  document.getElementById('w2plink').value)
      .then(function(){
        t.closePopup();
      });
    });

    document.getElementById("addnew").addEventListener('click', function(event){
      // Stop the browser trying to submit the form itself.
      event.preventDefault();

      // Hide fieldset to prevent double submission + disable save button
      document.getElementById('new').style.display = "none";
      document.getElementById('save').disabled = true;

      // Create new task, return url in w2plink field & re-enable button once done

      return t.get('board', 'private', 'settings')
      .then (function(settings){
            // Create a new XMLHttpRequest.
            var request = new XMLHttpRequest();

            // Handle state changes for the request.
            request.onreadystatechange = function(response) {
              if (request.readyState === 4) {
                if (request.status === 200) {
                  var response = JSON.parse(request.responseText);
                  var taskurl = "https://web2project.atmire.com/web2project/index.php?m=tasks&a=view&task_id=" + response.task_id;
                  document.getElementById('w2plink').value = taskurl;
                }
              }
            };

           var userid = document.getElementById('users').value;
           userid = userid.split("::")[1];

            var data = {
                "username": settings.username,
                 "password": settings.password,
                 "task_name" : document.getElementById('cardname').value,
                 "task_owner" : userid,
                 "description": "Trello-generated. Please create relevant subtasks for the corresponding ticket and assign them to the relevant person.",
                 "task_dynamic" : 1,
                 "dept_ids" : "array(1)",
                 "task_priority" : 0
            };
            request.setRequestHeader("Content-Type", "application/json");
            var pid = document.getElementById('projects').value;
            pid = pid.split("::")[1];

            // Set up and make the request.
            request.open('POST', 'https://atmire.com/w2p-api/project/' + pid + '/tasks', true);
            request.send(JSON.stringify(data));
      });

    });


    t.render(function(){
      return t.get('card', 'shared', 'w2plink')
      .then(function(link){
        document.getElementById('w2plink').value = link || "";
        if (document.getElementById('w2plink').value == ""){
          document.getElementById('new').style.display = "block";
        }
        return t.card('all')
      })
      .then(function(carddata){
         document.getElementById('cardname').value = carddata.name;
         return t.get('board', 'private', 'settings');
      })
      .then(function(settings){
          loadUsers(settings.username, settings.password);
          loadProjects(set.username, settings.password);
      })
      .then(function(){
        t.sizeTo('#w2p').done();
      });
    });


    function loadUsers(username, password) {

      var url = "https://atmire.com/w2p-api/contacts?username=" + username + "&password=" + password;

      var request = new XMLHttpRequest();
      var dataList = document.getElementById('users_list');

            // Handle state changes for the request.
      request.onreadystatechange = function(response) {
        if (request.readyState === 4) {
          if (request.status === 200) {
            var response = JSON.parse(request.responseText);

            for (var i in response.contacts){
              var option = document.createElement('option');
              option.value = response.contacts[i] + " ::" + i;
              dataList.appendChild(option);
            }


          }
        }
      };

      request.open('GET', url, true);
      request.send();
    }

    function loadProjects(username, password) {

      var url = "https://atmire.com/w2p-api/reports?username=" + username + "&password=" + password + "&report_type=projects_overview&type=SLA";

      var request = new XMLHttpRequest();
      var dataList = document.getElementById('projects_list');

            // Handle state changes for the request.
      request.onreadystatechange = function(response) {
        if (request.readyState === 4) {
          if (request.status === 200) {
            var response = JSON.parse(request.responseText);

            for (var i in response.projects){
              var option = document.createElement('option');
              option.value = response.projects[i].project_name + " (" +  response.projects[i].company_name + ")::" + response.projects[i].project_id;
              dataList.appendChild(option);
            }


          }
        }
      };

      request.open('GET', url, true);
      request.send();
    }
</script>
</body>
</html>